CC=@CC@

BUILD_SRC=../src
ROOT_SRC=@srcdir@/../src
ROOT_PYTHON=@srcdir@

PYTHON_EXEC?=python
CFLAGS=-I$(ROOT_PYTHON) -I$(ROOT_SRC)/include -I$(BUILD_SRC)/include -I$(ROOT_SRC)/lib/third_party/include \
	@CFLAGS@ @CUSTOM_NDPI@ -shared
LIBNDPI=$(BUILD_SRC)/.libs/libndpi.a
LDFLAGS=$(LIBNDPI) -lpcap  @LIBS@
SHARE=-soname,ndpi_wrap
SO=ndpi_wrap.so
CFILE=$(ROOT_PYTHON)/ndpi_wrap.c
PIC=-fPIC -DPIC
PREFIX?=@prefix@
.PHONY: all

UNAME_S := $(shell uname -s)
ifeq ($(UNAME_S),Darwin)
SHARE=-install_name,ndpiReader.so
endif

all: $(SO)

$(SO): $(CFILE) $(LIBNDPI) Makefile
	$(CC) $(CFLAGS) -Wl,$(SHARE) $(CFILE) -o $@ $(PIC) $(LDFLAGS)

example: $(SO)
	env NDPI_WRAP="$(realpath ./ndpi_wrap.so)" $(PYTHON_EXEC) $(ROOT_PYTHON)/ndpi_example.py

clean:
	/bin/rm -f $(SO)
